{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block body_class %}project-detail-page{% endblock %}

{% block title %}{{ project.title }} - Full Stack Project by Roshan Damor{% endblock %}

{% block extra_meta %}
<!-- SEO Meta Tags -->
<meta name="description" content="{{ project.summary|striptags|truncatechars:160 }}">
<meta name="keywords"
    content="{% for category in project.categories.all %}{{ category.name }}{% if not forloop.last %}, {% endif %}{% endfor %}, {% for tech in project.technologies.all %}{{ tech.name }}{% if not forloop.last %}, {% endif %}{% endfor %}, Roshan Damor project, web development, software project">
<meta name="author" content="Roshan Damor">
<link rel="canonical" href="{{ request.build_absolute_uri }}">

<!-- Open Graph Meta Tags -->
<meta property="og:title" content="{{ project.title }} - Project by Roshan Damor">
<meta property="og:description" content="{{ project.summary|striptags|truncatechars:200 }}">
<meta property="og:type" content="article">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
{% if project.cover_image %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ project.cover_image.url }}">
{% elif project.images.first %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ project.images.first.image.url }}">
{% endif %}
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="{{ project.title }}">
<meta property="og:site_name" content="Roshan Damor - Portfolio">
<meta property="article:author" content="Roshan Damor">
<meta property="article:published_time" content="{{ project.created_date|date:'c' }}">
{% for category in project.categories.all %}
<meta property="article:tag" content="{{ category.name }}">
{% endfor %}
{% for tech in project.technologies.all %}
<meta property="article:tag" content="{{ tech.name }}">
{% endfor %}

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ project.title }} - Project by Roshan Damor">
<meta name="twitter:description" content="{{ project.summary|striptags|truncatechars:200 }}">
{% if project.cover_image %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ project.cover_image.url }}">
{% elif project.images.first %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ project.images.first.image.url }}">
{% endif %}
<meta name="twitter:image:alt" content="{{ project.title }}">
<meta name="twitter:site" content="@logicbyroshan">
<meta name="twitter:creator" content="@logicbyroshan">

<!-- Structured Data for Project -->
<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "CreativeWork",
        "name": "{{ project.title }}",
        "description": "{{ project.summary|striptags }}",
        "url": "{{ request.build_absolute_uri }}",
        "creator": {
            "@type": "Person",
            "name": "Roshan Damor",
            "url": "{{ request.scheme }}://{{ request.get_host }}"
        },
        "dateCreated": "{{ project.created_date|date:'c' }}",
        {% if project.cover_image %}
        "image": "{{ request.scheme }}://{{ request.get_host }}{{ project.cover_image.url }}",
        {% endif %}
        "keywords": [
            {% for category in project.categories.all %}"{{ category.name }}"{% if not forloop.last %},{% endif %}{% endfor %}
            {% if project.categories.all and project.technologies.all %},{% endif %}
            {% for tech in project.technologies.all %}"{{ tech.name }}"{% if not forloop.last %},{% endif %}{% endfor %}
        ],
        "about": [
            {% for category in project.categories.all %}"{{ category.name }}"{% if not forloop.last %},{% endif %}{% endfor %}
        ]
    }
    </script>
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/project-dtl.css' %}">
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/project-dtl.js' %}" defer></script>
{% endblock %}


{% block content %}

    <!-- ======================= Breadcrumb Navigation ======================= -->
    <nav class="breadcrumb" aria-label="Breadcrumb" data-animation="fade-in-up">
        <ul>
            <li><a href="{% url 'portfolio:home' %}">Home</a></li>
            <li><a href="{% url 'portfolio:project_list' %}">Projects</a></li>
            <li class="active" aria-current="page">{{ project.title|truncatechars:30 }}</li>
        </ul>
    </nav>

    <div class="detail-page-container">
        <!-- ======================= Main Content Column ======================= -->
        <article class="detail-main-content">
            <header class="detail-page-header" data-animation="fade-in-up" data-animation-delay="100">
                <!-- DYNAMIC: Loop through project categories -->
                {% for category in project.categories.all %}
                    <span class="teg">{{ category.name }}</span>
                {% endfor %}
                <span class="teg"><i class="fa-regular fa-calendar-check"></i>{{ project.created_date|date:"M d, Y" }}</span>
            </header>

            <h1 class="project-title" data-animation="fade-in-up" data-animation-delay="200">{{ project.title }}</h1>
            <p class="project-description" data-animation="fade-in-up" data-animation-delay="300">{{ project.summary|safe }}</p>
            
            <!-- Image Slider -->
            <div class="hero-image-slider" id="project-slider" data-animation="zoom-in" data-animation-delay="400">
                <div class="slider-wrapper">
                    <!-- DYNAMIC: Loop through related project images -->
                    {% for p_image in project.images.all %}
                    <div class="slide"><img src="{{ p_image.image.url }}" alt="{{ p_image.caption|default:project.title }}"></div>
                    {% empty %}
                    <!-- Fallback if no slider images are uploaded -->
                    <div class="slide"><img src="{% if project.cover_image %}{{ project.cover_image.url }}{% else %}https://placehold.co/800x600/010409/eaeaea?text={{ project.title|urlencode }}{% endif %}" alt="{{ project.title }}"></div>
                    {% endfor %}
                </div>
                {% if project.images.all|length > 1 %}
                <div class="image-counter">
                    <span id="current-slide">1</span> / <span id="total-slides">{{ project.images.all|length }}</span>
                </div>
                <button class="slider-btn prev" id="prev-slide" aria-label="Previous Slide"><i class="fa-solid fa-chevron-left"></i></button>
                <button class="slider-btn next" id="next-slide" aria-label="Next Slide"><i class="fa-solid fa-chevron-right"></i></button>
                {% endif %}
            </div>
            
            <!-- DYNAMIC: Main Content Body from TinyMCE, marked as 'safe' to render HTML -->
            <div class="project-content-body" data-animation="fade-in-up">
                {{ project.content|safe }}
            </div>

            <!-- ======================= Comments Section ======================= -->
            <section class="comments-section" id="comments">
                <!-- DYNAMIC: Comment count -->
                <h2 data-animation="fade-in-up">Comments ({{ comments.count }})</h2>
                
                <!-- Comment Form -->
                {% if user.is_authenticated %}
                    <form class="comment-form card" id="comment-form" method="post" action="{% url 'portfolio:project_detail' slug=project.slug %}" data-animation="fade-in-up">
                        {% csrf_token %}
                        <div class="form-content">
                            <textarea name="body" placeholder="Share your thoughts about this project..." rows="3" required></textarea>
                            <button type="submit" class="filled-btn">Post Comment</button>
                        </div>
                    </form>
                {% else %}
                    <div class="comment-auth-prompt card" data-animation="fade-in-up">
                        <div class="auth-prompt-content">
                            <p>Sign in to join the conversation and share your thoughts about this project.</p>
                            <div class="auth-buttons">
                                <a href="{% url 'auth_app:login' %}?next={% url 'portfolio:project_detail' slug=project.slug %}%23comments" class="filled-btn">Sign In</a>
                                <a href="{% url 'auth_app:signup' %}?next={% url 'portfolio:project_detail' slug=project.slug %}%23comments" class="outline-btn">Create Account</a>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- List of Comments -->
                <div class="comment-list" id="comment-list">
                    <!-- DYNAMIC: Loop through comments from the view -->
                    {% for comment in comments %}
                    <div class="comment-item">
                        <div class="comment-header">
                            <div class="comment-avatar" data-avatar-color="{{ comment.author_name|avatar_color }}">
                                {{ comment.author_name|initials }}
                            </div>
                            <div class="comment-meta">
                                <h4 class="comment-author">{{ comment.author_name }}</h4>
                                <span class="comment-date">{{ comment.created_date|date:"F d, Y \a\t g:i A" }}</span>
                            </div>
                        </div>
                        <div class="comment-body">
                            <p>{{ comment.body|safe }}</p>
                        </div>
                        <div class="comment-actions">
                            <button class="like-btn{% if comment.id in user_liked_comments %} active{% endif %}" data-comment-id="{{ comment.id }}">
                                <i class="fa-{% if comment.id in user_liked_comments %}solid{% else %}regular{% endif %} fa-heart"></i>
                                <span class="like-count">{{ comment.total_likes }}</span>
                            </button>
                        </div>
                    </div>
                    {% empty %}
                        <p>Be the first to leave a comment about this project!</p>
                    {% endfor %}
                </div>
                
                <!-- Load More Button (controlled by JS) -->
                {% if has_more_comments %}
                    <button class="outline-btn" id="load-more-comments">Load More Comments</button>
                {% endif %}
            </section>
        </article>

        <!-- ======================= Sidebar ======================= -->
        <aside class="detail-sidebar" data-animation="fade-in-up" data-animation-delay="500">
            <div class="sidebar-card card">
                <h3>Project Info</h3>
                <div class="project-info-list">
                    <!-- DYNAMIC: Buttons only show if URLs exist -->
                    {% if project.github_url %}
                    <a href="{{ project.github_url }}" class="filled-btn" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> View Source Code</a>
                    {% endif %}
                    {% if project.live_url %}
                    <a href="{{ project.live_url }}" class="outline-btn" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt"></i> View Live Site</a>
                    {% endif %}
                </div>
            </div>
            <div class="sidebar-card card">
                <h3>Tech Stack</h3>
                <div class="project-skills-list">
                    <!-- DYNAMIC: Loop through technologies for this project -->
                    {% for tech in project.technologies.all %}
                    <span class="teg">{{ tech.name }}</span>
                    {% endfor %}
                </div>
            </div>
            <div class="sidebar-card card">
                <h3>Author</h3>
                <div class="author-info">
                    <img src="{% static 'images/author-avatar.png' %}" alt="Roshan Damor">
                    <div>
                        <h4>Roshan Damor</h4>
                        <p>Full-Stack Developer</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>
{% endblock %}