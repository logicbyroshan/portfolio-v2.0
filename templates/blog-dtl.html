{% extends "base.html" %}
{% load static %}

{% block title %}Blog: {{ blog.title }} - Roshan Damor{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/blog-dtl.css' %}">
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/blog-dtl.js' %}" defer></script>
{% endblock %}


{% block content %}
    <main class="main-container">

        <!-- ======================= Breadcrumb Navigation ======================= -->
        <nav class="breadcrumb" aria-label="Breadcrumb" data-animation="fade-in-up">
            <ul>
                <li><a href="{% url 'portfolio:home' %}">Home</a></li>
                <li><a href="{% url 'portfolio:blog_list' %}">Blog</a></li>
                <li class="active" aria-current="page">{{ blog.title|truncatechars:30 }}</li>
            </ul>
        </nav>

        <div class="detail-page-container">
            <!-- ======================= Main Content Column ======================= -->
            <article class="detail-main-content">
                <header class="detail-page-header" data-animation="fade-in-up" data-animation-delay="100">
                    <!-- DYNAMIC: Loop through post categories -->
                    {% for category in blog.categories.all %}
                        <span class="teg">{{ category.name }}</span>
                    {% endfor %}
                    <span class="teg"><i class="fa-regular fa-calendar-check"></i>{{ blog.created_date|date:"M d, Y" }}</span>
                </header>

                <h1 class="blog-title" data-animation="fade-in-up" data-animation-delay="200">{{ blog.title }}</h1>
                <p class="blog-summary" data-animation="fade-in-up" data-animation-delay="300">{{ blog.summary }}</p>
                
                <img class="blog-hero-image" src="{{ blog.cover_image.url }}" alt="{{ blog.title }}" data-animation="zoom-in" data-animation-delay="400">
                
                <!-- DYNAMIC: Main Content Body from TinyMCE, marked as 'safe' to render HTML -->
                <div class="blog-content-body" data-animation="fade-in-up">
                    {{ blog.content|safe }}
                </div>

                <!-- ======================= Comments Section ======================= -->
                <section class="comments-section" id="comments">
                    <!-- DYNAMIC: Comment count -->
                    <h2 data-animation="fade-in-up">Comments ({{ comments.count }})</h2>
                    
                    <!-- UPDATED: Comment Form with name/email fields and CSRF token -->
                    <form class="comment-form card" id="comment-form" method="post" action="" data-animation="fade-in-up">
                        {% csrf_token %}
                        <img src="{% static 'images/default_avatar.png' %}" alt="Your Avatar" class="comment-avatar">
                        <div class="form-content">
                            <div class="comment-form-fields">
                                <input type="text" name="name" placeholder="Your Name" required>
                                <input type="email" name="email" placeholder="Your Email" required>
                            </div>
                            <textarea name="body" placeholder="Join the discussion..." rows="3" required></textarea>
                            <button type="submit" class="filled-btn">Post Comment</button>
                        </div>
                    </form>

                    <!-- List of Comments -->
                    <div class="comment-list" id="comment-list">
                        <!-- DYNAMIC: Loop through comments from the view -->
                        {% for comment in comments %}
                        <div class="comment-item card hidden">
                            <div class="comment-avatar"><img src="https://i.pravatar.cc/40?u={{ comment.id }}" alt=""></div>
                            <div class="comment-body">
                                <div class="comment-header">
                                    <h5>{{ comment.author_name }}</h5>
                                    <span>{{ comment.created_date|timesince }} ago</span>
                                </div>
                                <p>{{ comment.body|linebreaks }}</p>
                                <div class="comment-actions">
                                    <button class="like-btn">
                                        <i class="fa-regular fa-heart"></i>
                                        <span class="like-count">{{ comment.likes }}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                            <p>Be the first to leave a comment!</p>
                        {% endfor %}
                    </div>
                    
                    <!-- Load More Button (controlled by JS) -->
                    {% if comments.count > 5 %}
                        <button class="outline-btn" id="load-more-comments">Load More Comments</button>
                    {% endif %}
                </section>
            </article>

            <!-- ======================= Sidebar ======================= -->
            <aside class="detail-sidebar" data-animation="fade-in-up" data-animation-delay="500">
                <div class="sidebar-card card">
                    <h3>Author</h3>
                    <div class="author-info">
                        {% if blog.author_avatar %}
                        <img src="{{ blog.author_avatar.url }}" alt="{{ blog.author_name }}">
                        {% else %}
                        <img src="{% static 'images/default_avatar.png' %}" alt="Default Avatar">
                        {% endif %}
                        <div>
                            <h4>{{ blog.author_name }}</h4>
                            <p>Full-Stack Developer</p>
                        </div>
                    </div>
                </div>
                <div class="sidebar-card card">
                    <h3>Share this Post</h3>
                    <!-- DYNAMIC: Share links with current page URL and title -->
                    <div class="share-buttons">
                        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ blog.title|urlencode }}" target="_blank" class="share-btn twitter" aria-label="Share on Twitter"><i class="fab fa-twitter"></i></a>
                        <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri }}&title={{ blog.title|urlencode }}&summary={{ blog.summary|urlencode }}" target="_blank" class="share-btn linkedin" aria-label="Share on LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                        <a href="mailto:?subject={{ blog.title|urlencode }}&body=Check out this article: {{ request.build_absolute_uri }}" class="share-btn email" aria-label="Share via Email"><i class="fas fa-envelope"></i></a>
                    </div>
                </div>
                <div class="sidebar-card card">
                    <h3>Suggested Posts</h3>
                    <div class="suggested-posts-list">
                        <!-- DYNAMIC: Loop through suggested posts from the view -->
                        {% for post in suggested_posts %}
                        <a href="{% url 'portfolio:blog_detail' slug=post.slug %}" class="suggested-post">
                            <img src="{{ post.cover_image.url }}" alt="{{ post.title }}">
                            <div class="post-info">
                                <h5>{{ post.title }}</h5>
                                <span>{{ post.created_date|date:"M d, Y" }}</span>
                            </div>
                        </a>
                        {% empty %}
                            <p>No other posts in this category yet.</p>
                        {% endfor %}
                    </div>
                </div>
            </aside>
        </div>
    </main>
    <!-- ======================= NEW: Subscribe Modal ======================= -->
    <div class="subscribe-modal" id="subscribe-modal">
        <div class="modal-content card" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div class="modal-header">
                <h3 id="modal-title">Subscribe to Comment</h3>
                <button id="close-subscribe-modal" class="close-btn" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>To keep the discussion valuable, please subscribe to my newsletter to post a comment. No spam, I promise!</p>
                <form class="subscribe-form-modal" id="subscribe-form-modal">
                    <!-- This CSRF token is read by JavaScript for the AJAX request -->
                    {% csrf_token %}
                    <input type="email" id="modal-email-input" placeholder="Enter your email..." required>
                    <button type="submit" class="filled-btn">Subscribe</button>
                </form>
                <p class="modal-message" id="modal-message"></p>
            </div>
        </div>
    </div>
{% endblock %}